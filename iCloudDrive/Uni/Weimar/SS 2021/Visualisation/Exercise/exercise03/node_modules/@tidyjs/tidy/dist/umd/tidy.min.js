(function(l,h){typeof exports=="object"&&typeof module!="undefined"?h(exports,require("d3-array")):typeof define=="function"&&define.amd?define(["exports","d3-array"],h):(l=typeof globalThis!="undefined"?globalThis:l||self,h(l.Tidy={},l.d3))})(this,function(l,h){"use strict";function z(n,...t){if(typeof n=="function")throw new Error("You must supply the data as the first argument to tidy()");let e=n;for(const u of t)u&&(e=u(e));return e}function sn(n){return e=>e.filter(n)}function ln(n,t){return u=>{if(typeof n=="function"){if(!n(u))return u}else if(!n)return u;return z(u,...t)}}function fn(n){return e=>e.map(n)}function S(n){return n==null?[]:Array.isArray(n)?n:[n]}function an(n){return e=>{if(n=S(n),!n.length){const r=new Set;for(const s of e)r.add(s);return Array.from(r)}const u=new Map,o=[],c=n[n.length-1];for(const r of e){let s=u,f=!1;for(const a of n){const i=typeof a=="function"?a(r):r[a];if(a===c){f=s.has(i),f||(o.push(r),s.set(i,!0));break}s.has(i)||s.set(i,new Map),s=s.get(i)}}return o}}function w(n){return e=>{const u=S(n).map(o=>typeof o=="function"?o:G(o));return e.slice().sort((o,c)=>{for(const r of u){const s=r(o,c);if(s)return s}return 0})}}function G(n){return function(e,u){return H(e[n],u[n],!1)}}function L(n){return function(e,u){return H(e[n],u[n],!0)}}function mn(n,t,e){let{position:u="start"}=e!=null?e:{};const o=u==="end"?-1:1,c=new Map;for(let s=0;s<t.length;++s)c.set(t[s],s);const r=typeof n=="function"?n:s=>s[n];return function(f,a){var i,m;const d=(i=c.get(r(f)))!=null?i:-1,y=(m=c.get(r(a)))!=null?m:-1;return d>=0&&y>=0?d-y:d>=0?o*-1:y>=0?o*1:0}}function H(n,t,e){let u=e?t:n,o=e?n:t;if($(u)&&$(o)){const s=(u!==u?0:u===null?1:2)-(o!==o?0:o===null?1:2);return e?-s:s}return $(u)?e?-1:1:$(o)?e?1:-1:h.ascending(u,o)}function $(n){return n==null||n!==n}function E(n,t){return u=>{t=t!=null?t:{};const o={},c=Object.keys(n);for(const r of c)o[r]=n[r](u);if(t.rest&&u.length){const r=Object.keys(u[0]);for(const s of r)c.includes(s)||(o[s]=t.rest(s)(u))}return[o]}}function R(n,t,e,u){if(!n.length)return[];const o={};let c;if(u==null)c=Object.keys(n[0]);else{c=[];for(const r of S(u))typeof r=="function"?c.push(...r(n)):c.push(r)}for(const r of c){if(e){const s=n.map(f=>f[r]);if(!e(s))continue}o[r]=t(r)(n)}return[o]}function P(n){return e=>R(e,n)}function Y(n,t){return u=>R(u,t,n)}function Z(n,t){return u=>R(u,t,void 0,n)}function k(n){return e=>{const u=[];for(const o of e){const c={...o};for(const r in n){const s=n[r],f=typeof s=="function"?s(c):s;c[r]=f}u.push(c)}return u}}function dn(n,t){return u=>{const o=E(n)(u),c=k(t)(o);return[...u,...c]}}function yn(n,t){return u=>{const o=P(n)(u),c=k(t)(o);return[...u,...c]}}function pn(n,t,e){return o=>{const c=Y(n,t)(o),r=k(e)(c);return[...o,...r]}}function hn(n,t,e){return o=>{const c=Z(n,t)(o),r=k(e)(c);return[...o,...r]}}function T(n,t){return{...n,...t.reduce((e,u)=>(e[u[0]]=u[1],e),{})}}function D(n,t,e,u,o,c=0){for(const[r,s]of n.entries()){const f=[...e,r];if(s instanceof Map){const a=u(t,f,c);D(s,a,f,u,o,c+1)}else o(t,f,s,c)}return t}function gn(n,t,e=u=>u[u.length-1]){function u(r,s){const f=new Map;return r.set(e(s),f),f}function o(r,s,f){r.set(e(s),t(f,s))}const c=new Map;return D(n,c,[],u,o),c}const O=n=>n;function _(n,t,e){return o=>{const c=_n(o,n),r=vn(c,t,e==null?void 0:e.addGroupKeys);if(e==null?void 0:e.export)switch(e.export){case"grouped":return r;case"entries":return j(r,{...e,export:"levels",levels:["entries"]});case"entries-object":case"entries-obj":case"entriesObject":return j(r,{...e,export:"levels",levels:["entries-object"]});case"object":return j(r,{...e,export:"levels",levels:["object"]});case"map":return j(r,{...e,export:"levels",levels:["map"]});case"keys":return j(r,{...e,export:"levels",levels:["keys"]});case"values":return j(r,{...e,export:"levels",levels:["values"]});case"levels":return j(r,e)}return bn(r,e==null?void 0:e.addGroupKeys)}}_.grouped=n=>({...n,export:"grouped"}),_.entries=n=>({...n,export:"entries"}),_.entriesObject=n=>({...n,export:"entries-object"}),_.object=n=>({...n,export:"object"}),_.map=n=>({...n,export:"map"}),_.keys=n=>({...n,export:"keys"}),_.values=n=>({...n,export:"values"}),_.levels=n=>({...n,export:"levels"});function vn(n,t,e){let u=n;if(!(t==null?void 0:t.length))return u;for(const o of t)u=gn(u,(c,r)=>{let f=o(c,{groupKeys:r});return e!==!1&&(f=f.map(a=>T(a,r))),f});return u}function _n(n,t){const e=S(t).map((o,c)=>{let r;typeof o=="function"?r=o.name?o.name:`group_${c}`:r=o.toString();const s=typeof o=="function"?o:a=>a[o],f=new Map;return a=>{const i=s(a);if(f.has(i))return f.get(i);const m=[r,i];return f.set(i,m),m}});return h.group(n,...e)}function bn(n,t){const e=[];return D(n,e,[],O,(u,o,c)=>{let r=c;t!==!1&&(r=c.map(s=>T(s,o))),u.push(...r)}),e}const Sn=n=>n.join("/");function Mn(n){var t;const{flat:e,single:u,mapLeaf:o=O,mapLeaves:c=O,addGroupKeys:r}=n;let s;return n.flat&&(s=(t=n.compositeKey)!=null?t:Sn),{groupFn:(i,m)=>u?o(r===!1?i[0]:T(i[0],m)):c(i.map(d=>o(r===!1?d:T(d,m)))),keyFn:e?i=>s(i.map(m=>m[1])):i=>i[i.length-1][1]}}function j(n,t){const{groupFn:e,keyFn:u}=Mn(t);let{mapEntry:o=O}=t;const{levels:c=["entries"]}=t,r=[];for(const i of c)switch(i){case"entries":case"entries-object":case"entries-obj":case"entriesObject":{const m=(i==="entries-object"||i==="entries-obj"||i==="entriesObject")&&t.mapEntry==null?([d,y])=>({key:d,values:y}):o;r.push({id:"entries",createEmptySubgroup:()=>[],addSubgroup:(d,y,g,b)=>{d.push(m([g,y],b))},addLeaf:(d,y,g,b)=>{d.push(m([y,g],b))}});break}case"map":r.push({id:"map",createEmptySubgroup:()=>new Map,addSubgroup:(m,d,y)=>{m.set(y,d)},addLeaf:(m,d,y)=>{m.set(d,y)}});break;case"object":r.push({id:"object",createEmptySubgroup:()=>({}),addSubgroup:(m,d,y)=>{m[y]=d},addLeaf:(m,d,y)=>{m[d]=y}});break;case"keys":r.push({id:"keys",createEmptySubgroup:()=>[],addSubgroup:(m,d,y)=>{m.push([y,d])},addLeaf:(m,d)=>{m.push(d)}});break;case"values":r.push({id:"values",createEmptySubgroup:()=>[],addSubgroup:(m,d)=>{m.push(d)},addLeaf:(m,d,y)=>{m.push(y)}});break;default:typeof i=="object"&&r.push(i)}const s=(i,m,d)=>{var y,g;if(t.flat)return i;const b=(y=r[d])!=null?y:r[r.length-1],A=((g=r[d+1])!=null?g:b).createEmptySubgroup();return b.addSubgroup(i,A,u(m),d),A},f=(i,m,d,y)=>{var g;((g=r[y])!=null?g:r[r.length-1]).addLeaf(i,u(m),e(d,m),y)},a=r[0].createEmptySubgroup();return D(n,a,[],s,f)}function Q(){return n=>n.length}function X(n){const t=typeof n=="function"?n:e=>e[n];return e=>h.fsum(e,t)}function x(n){return e=>{const{name:u="n",wt:o}=n!=null?n:{};return E({[u]:o==null?Q():X(o)})(e)}}function jn(n,t){return u=>{t=t!=null?t:{};const{name:o="n",sort:c}=t;return z(u,_(n,[x(t)]),c?w(L(o)):O)}}function wn(n){return e=>e.map(u=>{var o;const c={},r=Object.keys(u);for(const s of r){const f=(o=n[s])!=null?o:s;c[f]=u[s]}return c})}function W(n,t){return u=>u.slice(n,t)}const kn=n=>W(0,n),Kn=n=>W(-n);function Fn(n,t){return u=>w(t)(u).slice(0,n)}function In(n,t){return u=>typeof t=="function"?w(t)(u).slice(-n).reverse():w(L(t))(u).slice(0,n)}function On(n,t){t=t!=null?t:{};const{replace:e}=t;return o=>{if(!o.length)return o.slice();if(e){const c=[];for(let r=0;r<n;++r)c.push(o[Math.floor(Math.random()*o.length)]);return c}return h.shuffle(o.slice()).slice(0,n)}}function U(n,t){if(n.length===0||t.length===0)return{};const e=Object.keys(n[0]),u=Object.keys(t[0]),o={};for(const c of e)u.includes(c)&&(o[c]=c);return o}function V(n){if(Array.isArray(n)){const t={};for(const e of n)t[e]=e;return t}else if(typeof n=="object")return n;return{[n]:n}}function J(n,t,e){for(const u in e){const o=e[u];if(n[o]!==t[u])return!1}return!0}function An(n,t){return u=>{const o=(t==null?void 0:t.by)==null?U(u,n):V(t.by);return u.flatMap(r=>n.filter(f=>J(r,f,o)).map(f=>({...r,...f})))}}function nn(n,t){return u=>{const o=(t==null?void 0:t.by)==null?U(u,n):V(t.by);return u.flatMap(r=>{const s=n.filter(f=>J(r,f,o));return s.length?s.map(f=>({...r,...f})):r})}}function zn(n,t){return u=>{const o=(t==null?void 0:t.by)==null?U(u,n):V(t.by),c=new Map,r=u.flatMap(s=>{const f=n.filter(a=>{const i=J(s,a,o);return i&&c.set(a,!0),i});return f.length?f.map(a=>({...s,...a})):s});for(const s of n)c.has(s)||r.push(s);return r}}function $n(n){return e=>{const u=e.map(o=>({...o}));for(const o in n){const c=n[o],r=typeof c=="function"?c(u):c,s=(r==null?void 0:r[Symbol.iterator])&&typeof r!="string"?r:e.map(()=>r);let f=-1;for(const a of u)a[o]=s[++f]}return u}}function K(n){return n.length<1?[]:Object.keys(n[0])}function en(){return n=>K(n)}function tn(n,t){let e=[];for(const c of S(t))typeof c=="function"?e.push(...c(n)):e.push(c);e.length&&e[0][0]==="-"&&(e=[...en()(n),...e]);const u={},o=[];for(let c=e.length-1;c>=0;c--){const r=e[c];if(r[0]==="-"){u[r.substring(1)]=!0;continue}if(u[r]){u[r]=!1;continue}o.unshift(r)}return e=Array.from(new Set(o)),e}function N(n){return e=>{let u=tn(e,n);return u.length?e.map(o=>{const c={};for(const r of u)c[r]=o[r];return c}):e}}function Tn(n){return e=>{const u=k(n)(e);return N(Object.keys(n))(u)}}function un(n){return e=>typeof n=="function"?[...e,...S(n(e))]:[...e,...S(n)]}function Dn(n){return e=>{const{namesFrom:u,valuesFrom:o,valuesFill:c,valuesFillMap:r,namesSep:s="_"}=n,f=Array.isArray(u)?u:[u],a=Array.isArray(o)?o:[o],i=[];if(!e.length)return i;const m=Object.keys(e[0]).filter(p=>!f.includes(p)&&!a.includes(p)),d={};for(const p of e)for(const v of f)d[v]==null&&(d[v]={}),d[v][p[v]]=!0;const y=[];for(const p in d)y.push(Object.keys(d[p]));const g={},b=qn(s,y);for(const p of b){if(a.length===1){g[p]=r!=null?r[a[0]]:c;continue}for(const v of a)g[`${v}${s}${p}`]=r!=null?r[v]:c}function F(p){if(!p.length)return[];const v={...g};for(const M of m)v[M]=p[0][M];for(const M of p){const C=f.map(I=>M[I]).join(s);if(a.length===1){v[C]=M[a[0]];continue}for(const I of a)v[`${I}${s}${C}`]=M[I]}return[v]}return m.length?z(e,_(m,[F])):F(e)}}function qn(n="_",t){function e(o,c,r){if(!r.length&&c!=null){o.push(c);return}const s=r[0],f=r.slice(1);for(const a of s)e(o,c==null?a:`${c}${n}${a}`,f)}const u=[];return e(u,null,t),u}function Cn(n){return e=>{var u;const{namesTo:o,valuesTo:c,namesSep:r="_"}=n,s=(u=n.cols)!=null?u:[],f=tn(e,s),a=Array.isArray(o)?o:[o],i=Array.isArray(c)?c:[c],m=a.length>1,d=i.length>1,y=[];for(const g of e){const b=Object.keys(g).filter(p=>!f.includes(p)),F={};for(const p of b)F[p]=g[p];const A=d?Array.from(new Set(f.map(p=>p.substring(p.indexOf(r)+1)))):f;for(const p of A){const v={...F};for(const M of i){const C=d?`${M}${r}${p}`:p,I=m?p.split(r):[p];let ge=0;for(const ve of a){const _e=I[ge++];v[ve]=_e,v[M]=g[C]}}y.push(v)}}return y}}function rn(n){return e=>{const u=En(n),o=[];for(const c in u){const r=u[c];let s;typeof r=="function"?s=r(e):Array.isArray(r)?s=r:s=Array.from(new Set(e.map(f=>f[c]))),o.push(s.map(f=>({[c]:f})))}return Ln(o)}}function Ln(n){function t(u,o,c){if(!c.length&&o!=null){u.push(o);return}const r=c[0],s=c.slice(1);for(const f of r)t(u,{...o,...f},s)}const e=[];return t(e,null,n),e}function En(n){if(Array.isArray(n)){const t={};for(const e of n)t[e]=e;return t}else if(typeof n=="object")return n;return{[n]:n}}function on(n,t=1){let[e,u]=h.extent(n);const o=[];let c=e;for(;c<=u;)o.push(c),c+=t;return o}function B(n,t="day",e=1){let[u,o]=h.extent(n);const c=[];let r=new Date(u);for(;r<=o;)if(c.push(new Date(r)),t==="second"||t==="s"||t==="seconds")r.setUTCSeconds(r.getUTCSeconds()+1*e);else if(t==="minute"||t==="min"||t==="minutes")r.setUTCMinutes(r.getUTCMinutes()+1*e);else if(t==="day"||t==="d"||t==="days")r.setUTCDate(r.getUTCDate()+1*e);else if(t==="week"||t==="w"||t==="weeks")r.setUTCDate(r.getUTCDate()+7*e);else if(t==="month"||t==="m"||t==="months")r.setUTCMonth(r.getUTCMonth()+1*e);else if(t==="year"||t==="y"||t==="years")r.setUTCFullYear(r.getUTCFullYear()+1*e);else throw new Error("Invalid granularity for date sequence: "+t);return c}function Rn(n,t){return function(u){t=t!=null?t:1;const o=typeof n=="function"?n:c=>c[n];return on(u.map(o),t)}}function Wn(n,t,e){return function(o){t=t!=null?t:"day",e=e!=null?e:1;const c=typeof n=="function"?n:r=>r[n];return B(o.map(c),t,e)}}function Un(n,t,e){return function(o){t=t!=null?t:"day",e=e!=null?e:1;const c=typeof n=="function"?n:r=>r[n];return B(o.map(r=>new Date(c(r))),t,e).map(r=>r.toISOString())}}function cn(n){return e=>{const u=[];for(const o of e){const c={...o};for(const r in n)c[r]==null&&(c[r]=n[r]);u.push(c)}return u}}function Vn(n,t){return u=>{const o=rn(n)(u),c=nn(u)(o);return t?cn(t)(c):c}}function Jn(n){return e=>{const u=S(n),o={};return e.map(c=>{const r={...c};for(const s of u)r[s]!=null?o[s]=r[s]:o[s]!=null&&(r[s]=o[s]);return r})}}function Nn(n,t){return(u,o)=>{var c;let r="[tidy.debug";if((c=o==null?void 0:o.groupKeys)==null?void 0:c.length){const y=o.groupKeys.map(g=>g.join(": ")).join(", ");y.length&&(r+="|"+y)}t=t!=null?t:{};const{limit:s=10,output:f="table"}=t,a="--------------------------------------------------------------------------------";let i=a.length;const m=r+"]"+(n==null?"":" "+n);return i=Math.max(0,i-(m.length+2)),console.log(`${m} ${a.substring(0,i)}`),console[f](s==null||s>=u.length?u:u.slice(0,s)),u}}function q(n,t,e){return n==null||t==null?void 0:t===0&&n===0?0:!e&&t===0?void 0:n/t}function Bn(n,t,e){return n==null||t==null?e?(n!=null?n:0)-(t!=null?t:0):void 0:n-t}function Gn(n,t,e){return n==null||t==null?e?(n!=null?n:0)+(t!=null?t:0):void 0:n+t}var Hn=Object.freeze({__proto__:null,rate:q,subtract:Bn,add:Gn});function Pn(n,t,e){const u=typeof n=="function"?n:s=>s[n],o=typeof t=="function"?t:s=>s[t],{predicate:c,allowDivideByZero:r}=e!=null?e:{};return c==null?s=>{const f=o(s),a=u(s);return q(a,f,r)}:s=>{if(!c(s))return;const f=o(s),a=u(s);return q(a,f,r)}}function Yn(n,t){let e=new h.Adder,u=0;return Float64Array.from(n,o=>e.add(+(t(o,u++,n)||0)))}function Zn(n,t){let e=0;for(let u=0;u<n.length;++u){const o=t(n[u],u,n);+o===o&&(e+=1)}return e?h.fsum(n,t)/e:void 0}function Qn(n){const t=typeof n=="function"?n:e=>e[n];return e=>Yn(e,t)}function Xn(n,t,e){const{partial:u=!1}=e!=null?e:{};return o=>o.map((c,r)=>{const s=r;if(!u&&s-n+1<0)return;const f=Math.max(0,s-n+1),a=o.slice(f,s+1);return t(a,s)})}function xn(n,t){const e=typeof n=="function"?n:c=>c[n],{n:u=1,default:o}=t!=null?t:{};return c=>c.map((r,s)=>{const f=c[s-u];return f==null?o:e(f)})}function ne(n,t){const e=typeof n=="function"?n:c=>c[n],{n:u=1,default:o}=t!=null?t:{};return c=>c.map((r,s)=>{const f=c[s+u];return f==null?o:e(f)})}function ee(n){const t=typeof n=="function"?n:e=>e[n];return e=>h.min(e,t)}function te(n){const t=typeof n=="function"?n:e=>e[n];return e=>h.max(e,t)}function ue(n){const t=typeof n=="function"?n:e=>e[n];return e=>Zn(e,t)}function re(n,t){const e=typeof n=="function"?n:o=>o[n],u=typeof t=="function"?t:o=>o[t];return o=>{const c=h.fsum(o,e),r=h.fsum(o,u);return q(c,r)}}function oe(n){const t=typeof n=="function"?n:e=>e[n];return e=>h.median(e,t)}function ce(n){const t=typeof n=="function"?n:e=>e[n];return e=>h.deviation(e,t)}function se(n){const t=typeof n=="function"?n:e=>e[n];return e=>h.variance(e,t)}function le(n,t={}){const e=typeof n=="function"?n:u=>u[n];return u=>{const o=new Map;let c=0;for(const r of u){const s=e(r);if(!o.has(s)){if(!t.includeUndefined&&s===void 0||t.includeNull===!1&&s===null)continue;c+=1,o.set(s,!0)}}return c}}function fe(n){const t=typeof n=="function"?n:e=>e[n];return e=>e.length?t(e[0]):void 0}function ae(n){const t=typeof n=="function"?n:e=>e[n];return e=>e.length?t(e[e.length-1]):void 0}function ie(n,t=!0){return e=>{const u=new RegExp(`^${n}`,t?"i":void 0);return K(e).filter(c=>u.test(c))}}function me(n,t=!0){return e=>{const u=new RegExp(`${n}$`,t?"i":void 0);return K(e).filter(c=>u.test(c))}}function de(n,t=!0){return e=>{const u=new RegExp(n,t?"i":void 0);return K(e).filter(c=>u.test(c))}}function ye(n){return t=>K(t).filter(u=>n.test(u))}function pe(n,t,e){return u=>{const o=K(u),c=[];for(let r=t[0];r<=t[1];++r){const s=e==null?r:new String("00000000"+r).slice(-e);c.push(`${n}${s}`)}return o.filter(r=>c.includes(r))}}function he(n){return t=>{let e=new Set;for(const o of S(n))if(typeof o=="function"){const c=o(t);for(const r of c)e.add(r)}else e.add(o);return Array.from(e).map(o=>`-${o}`)}}l.TMath=Hn,l.addItems=un,l.addRows=un,l.arrange=w,l.asc=G,l.complete=Vn,l.contains=de,l.count=jn,l.cumsum=Qn,l.debug=Nn,l.desc=L,l.deviation=ce,l.distinct=an,l.endsWith=me,l.everything=en,l.expand=rn,l.fill=Jn,l.filter=sn,l.first=fe,l.fixedOrder=mn,l.fullJoin=zn,l.fullSeq=Rn,l.fullSeqDate=Wn,l.fullSeqDateISOString=Un,l.groupBy=_,l.innerJoin=An,l.lag=xn,l.last=ae,l.lead=ne,l.leftJoin=nn,l.map=fn,l.matches=ye,l.max=te,l.mean=ue,l.meanRate=re,l.median=oe,l.min=ee,l.mutate=k,l.mutateWithSummary=$n,l.n=Q,l.nDistinct=le,l.negate=he,l.numRange=pe,l.pick=N,l.pivotLonger=Cn,l.pivotWider=Dn,l.rate=Pn,l.rename=wn,l.replaceNully=cn,l.roll=Xn,l.select=N,l.slice=W,l.sliceHead=kn,l.sliceMax=In,l.sliceMin=Fn,l.sliceSample=On,l.sliceTail=Kn,l.sort=w,l.startsWith=ie,l.sum=X,l.summarize=E,l.summarizeAll=P,l.summarizeAt=Z,l.summarizeIf=Y,l.tally=x,l.tidy=z,l.total=dn,l.totalAll=yn,l.totalAt=hn,l.totalIf=pn,l.transmute=Tn,l.variance=se,l.vectorSeq=on,l.vectorSeqDate=B,l.when=ln,Object.defineProperty(l,"__esModule",{value:!0})});
//# sourceMappingURL=tidy.min.js.map
